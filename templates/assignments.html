{% include 'header.html' %}
<body>
    {% include 'top_menus.html' %}
    
    <div class="container mx-auto px-4 py-8">
        <!-- Animated Background -->
        <div class="fixed inset-0 overflow-hidden pointer-events-none">
            <div class="absolute -top-40 -right-40 w-80 h-80 bg-blue-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
            <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-green-300 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse delay-1000"></div>
        </div>
        
        <!-- Header Section -->
        <div class="relative z-10 mb-8 animate__animated animate__fadeInDown">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold gradient-text mb-2">
                        <i class="fas fa-tasks mr-3"></i>Assignments
                    </h1>
                    <p class="text-gray-600">Manage and submit course assignments</p>
                </div>
                
                {% if session.role == 'teacher' %}
                <button id="addAssignment" 
                        class="ripple bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg font-medium hover:from-green-700 hover:to-emerald-700 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center group">
                    <i class="fas fa-plus mr-2 group-hover:rotate-90 transition-transform duration-300"></i>
                    Create Assignment
                </button>
                {% endif %}
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-white rounded-xl p-4 shadow-lg hover-lift">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-tasks text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Total Assignments</p>
                            <p class="text-2xl font-bold">{{ assignments|length }}</p>
                        </div>
                    </div>
                </div>
                
                {% if session.role == 'student' %}
                <div class="bg-white rounded-xl p-4 shadow-lg hover-lift">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Submitted</p>
                            <p class="text-2xl font-bold">
                                {{ assignments|selectattr('status', 'equalto', 'Submitted')|list|length }}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-4 shadow-lg hover-lift">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Pending</p>
                            <p class="text-2xl font-bold">
                                {{ assignments|selectattr('status', 'equalto', 'Pending')|list|length }}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-4 shadow-lg hover-lift">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Overdue</p>
                            <p class="text-2xl font-bold">
                                {{ assignments|selectattr('status', 'equalto', 'Overdue')|list|length }}
                            </p>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-white rounded-xl p-4 shadow-lg hover-lift">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-file-upload text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Submissions</p>
                            <p class="text-2xl font-bold">
                                {{ assignments|sum(attribute='submissions') }}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-4 shadow-lg hover-lift">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-chart-line text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Avg Grade</p>
                            <p class="text-2xl font-bold">78%</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-4 shadow-lg hover-lift">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-users text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Students</p>
                            <p class="text-2xl font-bold">
                                {{ assignments|sum(attribute='total_students') }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Filters -->
        <div class="relative z-10 bg-white rounded-2xl p-6 shadow-lg mb-6 animate__animated animate__fadeInUp">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Course</label>
                    <select class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 group-hover:border-blue-400">
                        <option value="">All Courses</option>
                        {% for course in courses %}
                        <option value="{{ course.course_id }}">{{ course.course_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 group-hover:border-blue-400">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="submitted">Submitted</option>
                        <option value="graded">Graded</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                    <select class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-300 group-hover:border-blue-400">
                        <option value="">All Dates</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="past">Past Due</option>
                    </select>
                </div>
                
                <div class="flex items-end">
                    <button class="ripple w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:from-blue-700 hover:to-purple-700 transition-all duration-300 flex items-center justify-center group">
                        <i class="fas fa-filter mr-2 group-hover:rotate-180 transition-transform duration-300"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Assignments List -->
        <div class="relative z-10 space-y-6">
            {% for assignment in assignments %}
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden hover-lift animate-on-scroll" style="animation-delay: {{ loop.index0 * 100 }}ms">
                <div class="p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <div class="w-12 h-12 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white mr-4">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-gray-900">{{ assignment.title }}</h3>
                                    <div class="flex items-center space-x-4 mt-1">
                                        <span class="text-sm text-gray-600">
                                            <i class="fas fa-book mr-1"></i>{{ assignment.course_name }}
                                        </span>
                                        <span class="text-sm text-gray-600">
                                            <i class="fas fa-calendar-alt mr-1"></i>Due: {{ assignment.due_date }}
                                        </span>
                                        <span class="text-sm text-gray-600">
                                            <i class="fas fa-star mr-1"></i>Max: {{ assignment.max_marks }} marks
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-gray-600 mb-4 line-clamp-2">{{ assignment.description }}</p>
                            
                            <!-- Status Badge -->
                            {% if session.role == 'student' %}
                            <div class="inline-block">
                                {% if assignment.status == 'Submitted' %}
                                <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>Submitted
                                    {% if assignment.marks_obtained %}
                                    â€¢ {{ assignment.marks_obtained }}/{{ assignment.max_marks }}
                                    {% endif %}
                                </span>
                                {% elif assignment.status == 'Overdue' %}
                                <span class="px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-exclamation-circle mr-1"></i>Overdue
                                </span>
                                {% else %}
                                <span class="px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-clock mr-1"></i>Pending
                                </span>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="inline-block">
                                <span class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                    <i class="fas fa-users mr-1"></i>{{ assignment.submissions }}/{{ assignment.total_students }} submissions
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Days Left Indicator -->
                        <div class="text-center ml-4">
                            <div class="w-16 h-16 rounded-full {% if assignment.due_date|days_until < 0 %}bg-red-100 text-red-600
                                {% elif assignment.due_date|days_until <= 2 %}bg-yellow-100 text-yellow-600
                                {% else %}bg-green-100 text-green-600{% endif %} flex flex-col items-center justify-center">
                                <span class="text-2xl font-bold">{{ assignment.due_date|days_until|abs }}</span>
                                <span class="text-xs">days</span>
                            </div>
                            <span class="text-xs text-gray-500 mt-1">
                                {% if assignment.due_date|days_until < 0 %}overdue{% else %}left{% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                        <div class="flex items-center space-x-4">
                            {% if session.role == 'student' %}
                            {% if assignment.status != 'Submitted' %}
                            <a href="{{ url_for('assignment_details', assignment_id=assignment.assignment_id) }}" 
                               class="ripple px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 group">
                                <i class="fas fa-upload mr-2 group-hover:scale-110 transition-transform duration-300"></i>
                                Submit Now
                            </a>
                            {% endif %}
                            {% else %}
                            <a href="{{ url_for('assignment_details', assignment_id=assignment.assignment_id) }}" 
                               class="ripple px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-300 group">
                                <i class="fas fa-eye mr-2 group-hover:scale-110 transition-transform duration-300"></i>
                                View Submissions
                            </a>
                            {% endif %}
                            
                            <a href="{{ url_for('assignment_details', assignment_id=assignment.assignment_id) }}" 
                               class="ripple px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300 group">
                                <i class="fas fa-info-circle mr-2 group-hover:rotate-12 transition-transform duration-300"></i>
                                Details
                            </a>
                        </div>
                        
                        {% if session.role == 'teacher' %}
                        <div class="flex items-center space-x-2">
                            <button class="ripple w-10 h-10 rounded-lg bg-gradient-to-r from-green-500 to-green-600 text-white flex items-center justify-center hover:from-green-600 hover:to-green-700 transition-all duration-300 group">
                                <i class="fas fa-edit group-hover:rotate-12 transition-transform duration-300"></i>
                            </button>
                            <button class="ripple w-10 h-10 rounded-lg bg-gradient-to-r from-red-500 to-red-600 text-white flex items-center justify-center hover:from-red-600 hover:to-red-700 transition-all duration-300 group">
                                <i class="fas fa-trash-alt group-hover:scale-110 transition-transform duration-300"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- Empty State -->
            {% if not assignments %}
            <div class="bg-white rounded-2xl shadow-xl p-12 text-center">
                <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-r from-gray-100 to-gray-200 flex items-center justify-center">
                    <i class="fas fa-tasks text-gray-400 text-4xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">No Assignments Yet</h3>
                <p class="text-gray-600 mb-6">
                    {% if session.role == 'teacher' %}
                    Create your first assignment to get started
                    {% else %}
                    You don't have any assignments at the moment
                    {% endif %}
                </p>
                {% if session.role == 'teacher' %}
                <button id="addAssignmentEmpty" 
                        class="ripple bg-gradient-to-r from-green-600 to-emerald-600 text-white px-8 py-3 rounded-lg font-medium hover:from-green-700 hover:to-emerald-700 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl">
                    <i class="fas fa-plus mr-2"></i>Create First Assignment
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Add Assignment Modal -->
    <div id="assignmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all duration-500 scale-95">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold" id="assignmentModalTitle">
                        <i class="fas fa-plus mr-2"></i>Create New Assignment
                    </h3>
                    <button type="button" class="text-white hover:text-gray-200 transition-colors duration-300" onclick="closeAssignmentModal()">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <form method="post" id="assignmentForm" action="{{ url_for('assignments') }}" class="p-6 max-h-[80vh] overflow-y-auto">
                <div class="space-y-4">
                    <!-- Title -->
                    <div class="group">
                        <label for="title" class="block text-sm font-medium text-gray-700 mb-2 group-hover:text-green-600 transition-colors duration-300">
                            <i class="fas fa-heading mr-2"></i>Assignment Title*
                        </label>
                        <input type="text" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 group-hover:border-green-400" 
                               id="title" name="title" placeholder="Enter assignment title" required>
                    </div>
                    
                    <!-- Course -->
                    <div class="group">
                        <label for="course_id" class="block text-sm font-medium text-gray-700 mb-2 group-hover:text-green-600 transition-colors duration-300">
                            <i class="fas fa-book mr-2"></i>Course*
                        </label>
                        <select name="course_id" id="course_id" 
                                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 group-hover:border-green-400" required>
                            <option value="">Select Course</option>
                            {% for course in courses %}
                                <option value="{{ course.course_id }}">{{ course.course_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Description -->
                    <div class="group">
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-2 group-hover:text-green-600 transition-colors duration-300">
                            <i class="fas fa-align-left mr-2"></i>Description*
                        </label>
                        <textarea class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 group-hover:border-green-400" 
                                  rows="4" id="description" name="description" placeholder="Assignment description and instructions..." required></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Due Date -->
                        <div class="group">
                            <label for="due_date" class="block text-sm font-medium text-gray-700 mb-2 group-hover:text-green-600 transition-colors duration-300">
                                <i class="fas fa-calendar-day mr-2"></i>Due Date*
                            </label>
                            <input type="date" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 group-hover:border-green-400" 
                                   id="due_date" name="due_date" required>
                        </div>
                        
                        <!-- Max Marks -->
                        <div class="group">
                            <label for="max_marks" class="block text-sm font-medium text-gray-700 mb-2 group-hover:text-green-600 transition-colors duration-300">
                                <i class="fas fa-star mr-2"></i>Maximum Marks
                            </label>
                            <input type="number" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 group-hover:border-green-400" 
                                   id="max_marks" name="max_marks" value="100" min="1" max="1000" step="0.5">
                        </div>
                    </div>
                    
                    <!-- Additional Instructions -->
                    <div class="group">
                        <label for="instructions" class="block text-sm font-medium text-gray-700 mb-2 group-hover:text-green-600 transition-colors duration-300">
                            <i class="fas fa-list-check mr-2"></i>Additional Instructions
                        </label>
                        <textarea class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 group-hover:border-green-400" 
                                  rows="3" id="instructions" name="instructions" placeholder="Any special instructions for students..."></textarea>
                    </div>
                    
                    <!-- File Attachment (Optional) -->
                    <div class="group">
                        <label for="attachment" class="block text-sm font-medium text-gray-700 mb-2 group-hover:text-green-600 transition-colors duration-300">
                            <i class="fas fa-paperclip mr-2"></i>Attachment (Optional)
                        </label>
                        <div class="relative">
                            <input type="file" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-300 group-hover:border-green-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" 
                                   id="attachment" name="attachment" accept=".pdf,.doc,.docx,.txt">
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="mt-6 flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeAssignmentModal()" 
                            class="ripple px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300 hover:scale-105">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="ripple px-6 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 transition-all duration-300 hover:scale-105 shadow-lg hover:shadow-xl flex items-center group">
                        <i class="fas fa-plus-circle mr-2 group-hover:rotate-90 transition-transform duration-300"></i>
                        Create Assignment
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Open Add Assignment Modal
            document.getElementById('addAssignment')?.addEventListener('click', openAssignmentModal);
            document.getElementById('addAssignmentEmpty')?.addEventListener('click', openAssignmentModal);
            
            // Set minimum date to today for due date
            const dueDateInput = document.getElementById('due_date');
            if (dueDateInput) {
                const today = new Date().toISOString().split('T')[0];
                dueDateInput.min = today;
                dueDateInput.value = today;
            }
            
            // Assignment card animations
            const assignmentCards = document.querySelectorAll('.hover-lift');
            assignmentCards.forEach((card, index) => {
                // Add stagger animation
                card.style.animationDelay = `${index * 100}ms`;
                
                // Hover effect
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-8px)';
                    this.querySelector('.bg-gradient-to-r')?.classList.add('scale-110');
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.querySelector('.bg-gradient-to-r')?.classList.remove('scale-110');
                });
            });
            
            // Status color coding
            const statusIndicators = document.querySelectorAll('[class*="bg-"]:not(.hover-lift)');
            statusIndicators.forEach(indicator => {
                if (indicator.textContent.includes('Overdue')) {
                    indicator.classList.add('animate-pulse');
                }
            });
        });
        
        function openAssignmentModal() {
            const modal = document.getElementById('assignmentModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.transform').classList.remove('scale-95');
                modal.querySelector('.transform').classList.add('scale-100');
            }, 10);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        function closeAssignmentModal() {
            const modal = document.getElementById('assignmentModal');
            modal.querySelector('.transform').classList.remove('scale-100');
            modal.querySelector('.transform').classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }, 300);
        }
        
        // Close modal on outside click
        document.getElementById('assignmentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAssignmentModal();
            }
        });
        
        // Auto-calculate days until due date
        function calculateDaysUntil(dateString) {
            const dueDate = new Date(dateString);
            const today = new Date();
            const diffTime = dueDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        // Update days left indicators
        document.querySelectorAll('[data-due-date]').forEach(element => {
            const dueDate = element.getAttribute('data-due-date');
            const daysUntil = calculateDaysUntil(dueDate);
            element.textContent = Math.abs(daysUntil);
            
            // Update parent class based on days
            const parent = element.closest('.rounded-full');
            if (parent) {
                parent.className = parent.className.replace(/bg-\w+-\d+ text-\w+-\d+/, '');
                if (daysUntil < 0) {
                    parent.classList.add('bg-red-100', 'text-red-600');
                } else if (daysUntil <= 2) {
                    parent.classList.add('bg-yellow-100', 'text-yellow-600');
                } else {
                    parent.classList.add('bg-green-100', 'text-green-600');
                }
            }
        });
    </script>
</body>
</html>